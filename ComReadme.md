#### Communication
- 카메라 --> Rasberry PI --> STM32 --> DRIVER --> MOTOR 
# 2023.2.17 
카메라는 OpenCV를 이용해서 일단 진행 예정, 문제는 Rasberry PI -> STM32로 전송시 일반선 연결로는 노이즈가 많이 심함... 노이즈를 줄일 방법또는 다른 모듈을 찾아야 할지도...(with. PMG), STM32 -> DRIVER는 UART기능에서 RS485 통신기능을 이용해볼 예정(구매한 후 해봐야 알듯))

# 2023.2.20 
전송시 꺠짐 문제 해결(전압 3.3V를 STM32에 넣어주니 Ras->STM->Win 통신 완료) -> STM32에서 UART1,2 모두 사용해서 연결함, 원래는 통신속도를 Ras->stm32를 9600으로 하고 stm32->Motor를 19200으로 하려고 했으나, 일부 글자가 짤려서 나오기에 19200으로 통신속도 통일 할 예정(Double_UART 폴더 파일)

# 2023.2.21 
라즈베리파이에서 OpenCV로 카메라 켜서 일정한 부분에 경계선이 감지되면 Ras -> Win 으로 메세지를 전송하는 통신 과정 완료 (전송 과정중에서 글자가 일부 짤리는 현상이 발생했는데 이는 전송 시간 또는 전송 객체 문제일거라 생각됨) (Cam_Code -> Cam_send.py 참고)

(CAMERA --> MOTOR) 여기 까지 오기의 통신을 할 수 있느냐. 이 부분도 상당히 난이도가 높을 것이라고 생각함
- 계단 인식 밑,  평면상에서의 움직임제어 LEFT, RIGHT

- 배터리 윗쪽 가이드 설치, Battery Management system 확인 -> 모터드라이브 20A*2 + 라즈베리파이4 3A + STM32F103RB 약 1~2A 이하로 추정 ~= 24V 50A 짜리 BMS 사면 될듯함. 
- PCB로 해야하는지? , 그냥 기판으로 가야하는지  --> Noise가 얼마나 심한지 확인해봐야함?
- 

# 2023.2. 27
MDAS -> 라즈베리파이 송신 시 오류
1. 예) 183을 송신하는데 int형으로 보내짐(반대로 char로 받으면 값이 다르게 나옴)
2. 한번 보내지고 나서 연결이 끊기는 현상을 보임(MDAS 쓰레기.....)
3. 반대로 라즈베리파이에서 MDAS로 송신할때 데이터를 제대로 받기는 하나, MDAS 터미널에서 받지 못함

- 주의할것 
1. 변수타입 (MDAS에서 STM32로 제대로 받을려면 데이터타입을 int(uint32_t)로 선언해야함. 라는 개인적인 생각)
2. MAX485 연결방법 숙지 STM32 DE pin을 MAX485에 RE에 연결 TX(pin D5)->DI, RX(pin D4)->RO에 연결 
3. Molex 필요할듯 (준호가 개인적으로 구입함)
4. USB-485 커넥터 구매해서 오면 해볼예정

연결해야하는 방법

Window MDAS Program (UART2 USB->STM32) -> STM32 (UART2-> UART1) -> 
Motor Driver  (UART1 RS485-MAX485) -> 3상 연결 Motor


# 2023.2.28 (by KJH)
stm32에서 RTOS 사용방법과 역할에 대해 찾아봄
stm32에서 RTOS를 사용하기 위해선 CMSIS-RTOS API의 Free RTOS를 사용해야함(IDE에 기본으로 내장되어 있음)
기존의 RTOS를 사용하지 않는 프로그램에서는 main문을 하나만 사용한다면, RTOS를 사용한 프로그램은 main문을 독립적으로 여러개 생성하는 효과를 얻을 수 있다. 즉, 여러 개의 Task를 동시에 수행할 수 있다. 
이 때 task마다 우선순위를 설정해주어야 하는데 우선순위를 제대로 설정해 주지 않으면 충돌이 일어날 수 있음
- RTOS를 활용해 여러개의 LED를 서로 다른 주기로 깜빡이게 만드는 프로그램을 올림 확인바람

참고자료
https://blog.naver.com/0ljy0/222149773283

// SapBori -> RTOS 종류 및 사용법 in LiNux
리눅스 스케쥴링
- BATCH
- IDLE
- DeadLine
- *SCHED_Other
일반프로세스 타입, 별도 지정을 하지 않을 시에 설정 
- *SChed_FIFO((First in First Out),SChed_RR(Round Robin)
 RT를 위한 스케쥴링 Policy 

- RR -> 프로세스간 time-slicing (선점 시간할당)
- FIFO -> 우선순위제

리눅스 : nice or renice 또는 chrt로 우선순위 결정
Nice, Renice 는 +19~-20으로 낮을 수록 우선순위가 높음
일반 Process -> nice ||| RT process -> chrt

사용 명령어
chrt -f -p [우선순위 값] [프로세스번호]
| -f : FIFO 사용
| -o : Other 사용
| -r : RR 사용
ps(우선순위 알아보기)

# 2023.3.2 (by PMG)
- 모터 돌리기 성공 -> (CTRL 4번을 GND에 연결, 8번을 가변저항기 가운데에 연결, CTRL 9번 = 5V, CTRL 1번 GND 이렇게 연결한뒤, MDAS에 Send PID Write에 Input_Type을 0으로 두고 
24V에서 진행) : 한 사이클만 돌아가는데 이게 파워 서플라이의 출력이 부족해서 제대로 된 성능이 나오지 않는것 같음)
- 파워 서플라이가 아니라 파워 뱅크를 이용해서 모터를 돌려야 할듯(홍기형 의견) : 220V 선 필요..

# 2023.3.3 (by PMG)
- 모터 속도 조절 하게 만듬 + 모터드라이버 CTRL 핀들 13핀으로 묶음(속도 조절은 가변저항기를 이용해서 속도 조절) + SMPMS을 이용해서 모터 드라이브 작동성공
-- 2(DIR),4(START/STOP) Pin을 GND에 연결해야암 + 가변저항기의 가운데 선을 8(Speed In) 핀과 연결
-- 가변 저항기에 따라 속도가 조절되지만, 발열과 통신 문제 해결해야함.

# 2023.3.6(by PMG)(with KJH)
- 모터 토크 제어 성공 - 자세한건 HOW_TO_CONTROL... txt 파일 참조
- 모터 위치 제어도 성공 -> 자세한건 같이 올린 HOW_TO_CONTROL... txt
- 문제는 엔코더를 이용한 속도제어가 문제라고 생각됨 -> 엔코더를 사용하지 않고 홀센서 만으로 제어하는 ENC_OFF 명령어를 '쓰지 않는 경우' 모터가 덜덜 거리다가 에러를 내고 멈춤
- 이번주부터 STM32를 이용해서 모터 드라이브와의 통신(MDAS를 쓰지 않고)을 진행할 예정
- 모터 테스트 영상 주소 https://drive.google.com/file/d/1O3Y8ixFg5ewMUY9hgxx-sdSBJ0BZhaq9/view?usp=share_link

# 2023.3.7(by KJH)(with PMG)
- stm32와 모터드라이버간 rs485 통신 성공, MDAS를 쓰지 않아도 stm32를 통해 모터드라이버 기본설정 및 전류제어 전류값 명령 송신 가능
- stm32에 들어가는 프로그램 업로드 완료 확인 바람
- stm32와 컴퓨터는 USART2를 통해 시리얼 통신으로 연결되어 있으며 stm32와 모터드라이버는 USART1을 통해 RS485포트로 연결되어 있어야 작동이 됨
- 컴퓨터 시리얼 통신 프로그램으로 stm32에 숫자를 입력해주면 숫자에 맞는 명령들이 수행되게 함
- 추후에는 FREERTOS를 활용해서 제어기 설계를 해 볼 예정

# 2023.3.13(by KJH)
- MPU6050 센서값을 STM32로 받아 칼만필터를 사용, 값을 필터링 하는데 성공함
- 기존 상보필터에서 칼만 필터로 개조함
- 칼만필터 센서값을 출력하는 프로그램 업로드 완료 확인바람
- MPU6050에 3.3V의 전원 인가후 I2C통신을 위한 핀을 연결해주면 STM32 프로그램이 자동으로 I2C 통신을 위한 초기 설정 및 값을 받아옴
- 출력값은 USART 통신을 통해 확인가능 

같은 날 (by PMG)
- MPU6050 센서값을 Raspberry pi로 받아 출력,이후 칼만필터를 이용해서 필터링 예정
- RTOS CYCLE Test 결과는 많이 돌릴수록 MAX 레이턴시는 길어지나 평균은 25us 미만(Thread use1 -> MAX: 240us, Thread use 4-> MAX:320us)
- 블로그 글에서는 MAX도 100이하로 낮아진다고 했는데 이후 재설정 해볼 예정
- I2C에서 Slave를 여러개 달수 있다고 하는데 이후 공부를 좀더 해봐야 겠음(MPU6050을 동시에 두개 돌려보기)


# 2023.3.15(by PMG)
- xenomai라는 RT 리눅스 커널을 알게 되어서 이후 공부해볼 예정
- 일단은 교수님께서 리눅스 커널은 그대로 두고 제어 주기를 500us 정도로 잡고 해보라고 하셨음
- 칼만 필터는 커널 설치가 제대로 된다면 진행하고 안되면 커널이 터져서 고치고 있다라고 간주하시면 됩니다....(MPU6050 두개다 값이 받아지긴함)

# 2023.3.17(by PMG)
- RTOS는 리눅스에서 사용하는 실시간으로 작업을 할 수 있게 시간에 맞춰 CPU 자원을 선점할 수 있게 스케쥴링 해주는 운영체제로 라즈베리파이는 기본적으로 PreemPT_RT라는
RTOS가 존재함
- RTOS에서는 레이턴시가 중요한데 레이턴시는 '메모리가 다음 작업으로 처리하기 까지 걸리는 대기 시간'으로 이 시간이 낮을 수록 빠른 처리 속도를 보여줄수 있음
- 현재 기본 세팅만 사용하였을 때 PreemPT가 설치되어 있는데(커널버전 5.15.v84 기준), 대기시간 측정을 위해서 cycletest를 돌려보았을 때 Max: 400~500us -> 0.4ms ~ 0.5ms의 대기시간을 보여줌 
![cycletest](https://github.com/krokroak/2023_Capstone/blob/main/cycletest%20thread4.png)
- 현재로써는 제어 주기를 10KHz로 잡을 때 목표 최대 Latency -> 100us 이하 == 10KHz가 나오게 해야함. (timer가 10000번 진동 했을 때 1초
- 목표치에 따르면 100us 동안 양쪽 팔의 각도, 토크값(전류값) 측정-> 목표 각도가 위한 (제어값)전류값을 모터 드라이버에 전송 -> 모터 드라이버가 모터로 전류를 흘려보냄 -> 자세를 제어 : 이렇게 제어 해야함.

+ 영상 설명 : MDAS가 아닌 STM32로 UART 통신을 통해서 특정 키보드 입력을 받으면 특정 기능을 하도록 구현
--기능 1,2,3,4,5,6 까지 구현 + 알파벳 m--

1. Alarm_reset -> 초기화 버튼
1. TQ_Crtl -> 전류 제어를 사용하겠다는 명령어
1. TQ_Forward -> 정방향 회전(초기 전류값 1A)
1. TQ_Backward -> 역방향 회전 (초기 전류값 1A)
1. Brake -> 정지(전류값 -1A을 짧게 주었다가 0A 출력)
1. TQ_OFF -> 정지(전류값 0)
1. m -> (0~9) 숫자*0.5A (하나의 숫자만 입력받음) 최대 4.5A 전류 조절 가능
#################################################
#################  SENSOR, IC ###################
#################################################

IC --> LM7805, 5v Regulator
Sensor
--> MPU6050 or MPU9250 

# 2023.03.20 (by KMJ writing PMG)
- 모터 엔코더 값 읽기 설정법
  - POSI_RESET : 모터 위치 값을 0으로 셋 
  - ENC_PPR = 16384로 셋
  - USE_ENC_PHASE = 1 : 모터위치 엔코더로 읽어오기
  - 이렇게 하면 읽어오는 거 확인(확인 방법 : 엔코더 선 끊으면 모터 정지 및 OUT DATA = 0) 
# 2023.03.21 by PMG
- 모터 MPU6050으로 속도 조절 해봄
  - 문제는 값이 튀어서 모터 속도가 조절이 안되는 구간이 존재
  - 영상으로는 MPU6050의 센싱 Y축 기준으로 적용
  - I2C - D1,D2 UART2(RS485) - A7(TX-DI), A2(RX-RO), A1(DE-DE,RE)
  - 이후 준호가 손볼 예정
# 2023.03 22 by PMG
- MPU6050 KALMANFilter python 적용 버전은 이후 수정 예정(값이 계속 더해짐)
- 모터는 게인 문제일수도 있다고생각함, + -> -로 갈 때 빠르게 돈다는거는 오차에 의한 거일 수 도 있다..
- 오늘 Cycle Test 결과는 200us 
